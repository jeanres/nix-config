#!/usr/bin/env bash
#
# Pre-push hook
# Runs tests before pushing to remote
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}ğŸš€ Running pre-push checks...${NC}"

# Detect project type and run appropriate tests
run_tests() {
    # C# / .NET
    if [ -f "*.csproj" ] || [ -f "*.sln" ]; then
        echo -e "${BLUE}ğŸ§ª Running .NET tests...${NC}"
        if dotnet test --no-build --verbosity quiet; then
            echo -e "${GREEN}âœ“ .NET tests passed${NC}"
            return 0
        else
            echo -e "${RED}âŒ .NET tests failed${NC}"
            return 1
        fi
    fi
    
    # Ruby / Rails
    if [ -f "Gemfile" ]; then
        echo -e "${BLUE}ğŸ§ª Running Ruby tests...${NC}"
        if [ -f "bin/rails" ]; then
            # Rails project
            if bundle exec rails test; then
                echo -e "${GREEN}âœ“ Rails tests passed${NC}"
                return 0
            else
                echo -e "${RED}âŒ Rails tests failed${NC}"
                return 1
            fi
        elif [ -f "spec" ]; then
            # RSpec
            if bundle exec rspec; then
                echo -e "${GREEN}âœ“ RSpec tests passed${NC}"
                return 0
            else
                echo -e "${RED}âŒ RSpec tests failed${NC}"
                return 1
            fi
        fi
    fi
    
    # Java / Maven
    if [ -f "pom.xml" ]; then
        echo -e "${BLUE}ğŸ§ª Running Maven tests...${NC}"
        if mvn test -q; then
            echo -e "${GREEN}âœ“ Maven tests passed${NC}"
            return 0
        else
            echo -e "${RED}âŒ Maven tests failed${NC}"
            return 1
        fi
    fi
    
    # Java / Gradle
    if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
        echo -e "${BLUE}ğŸ§ª Running Gradle tests...${NC}"
        if ./gradlew test -q; then
            echo -e "${GREEN}âœ“ Gradle tests passed${NC}"
            return 0
        else
            echo -e "${RED}âŒ Gradle tests failed${NC}"
            return 1
        fi
    fi
    
    # Node.js
    if [ -f "package.json" ]; then
        echo -e "${BLUE}ğŸ§ª Running Node.js tests...${NC}"
        if npm test; then
            echo -e "${GREEN}âœ“ Node.js tests passed${NC}"
            return 0
        else
            echo -e "${RED}âŒ Node.js tests failed${NC}"
            return 1
        fi
    fi
    
    # No tests found
    echo -e "${YELLOW}âš ï¸  No test suite detected, skipping tests${NC}"
    return 0
}

# Run the tests
if ! run_tests; then
    echo ""
    echo -e "${RED}âŒ Pre-push checks failed!${NC}"
    echo -e "${YELLOW}Fix the failing tests or use 'git push --no-verify' to skip checks.${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}âœ… All pre-push checks passed!${NC}"
exit 0
