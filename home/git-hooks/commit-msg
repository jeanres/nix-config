#!/usr/bin/env bash
#
# Commit message hook
# Validates commit message format and quality
#

set -e

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Skip checks for merge commits, revert commits, etc.
if echo "$COMMIT_MSG" | grep -qE "^(Merge|Revert|fixup!|squash!)"; then
    exit 0
fi

# Check minimum length
if [ ${#COMMIT_MSG} -lt 10 ]; then
    echo -e "${RED}❌ Commit message too short (minimum 10 characters)${NC}"
    exit 1
fi

# Check for common bad patterns
if echo "$COMMIT_MSG" | grep -qiE "^(wip|todo|fixme|temp|test|asdf|foo|bar)$"; then
    echo -e "${RED}❌ Commit message appears to be a placeholder${NC}"
    echo -e "${YELLOW}Please write a meaningful commit message.${NC}"
    exit 1
fi

# Warn about very long first lines (but don't fail)
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)
if [ ${#FIRST_LINE} -gt 72 ]; then
    echo -e "${YELLOW}⚠️  First line is longer than 72 characters (${#FIRST_LINE})${NC}"
    echo -e "${YELLOW}Consider keeping it under 72 for better readability.${NC}"
fi

# Check for imperative mood (common convention)
if echo "$FIRST_LINE" | grep -qE "^(Added|Fixed|Updated|Changed|Removed|Created)"; then
    echo -e "${YELLOW}⚠️  Consider using imperative mood: 'Add' not 'Added', 'Fix' not 'Fixed'${NC}"
fi

echo -e "${GREEN}✓ Commit message looks good${NC}"
exit 0
